<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BFSI Voice Agent Dashboard</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="top-panel">
    <h2>ğŸ‘¤ Customer Snapshot â€” <span id="cust-name">Aarav Sharma</span></h2>
    <div class="info-grid">
      <div>ğŸ“± Mobile: <span id="cust-phone">9876543210</span></div>
      <div>ğŸ’° Balance: â‚¹<span id="balance">125430</span></div>
      <div>ğŸ’³ Card: <span id="card">Active</span></div>
      <div>ğŸ  EMI Due: <span id="emi">Nov 5, 2025</span></div>
      <div>ğŸ©º Claim: <span id="claim">Under Review</span></div>
    </div>
  </div>

  <div class="container">
    <div class="left">
      <img src="https://cdn-icons-png.flaticon.com/512/2920/2920348.png" class="logo" onclick="startCall()" alt="Call Agent" />
      <h3>Call Agent</h3>
      <div class="examples">
        <h4>Try saying:</h4>
        <ul>
          <li>Whatâ€™s my balance?</li>
          <li>Block my card</li>
          <li>When is my next EMI due?</li>
          <li>Whatâ€™s my claim status?</li>
        </ul>
      </div>
    </div>
    <div class="right">
      <h2>ğŸ—£ï¸ Conversation</h2>
      <div id="chat-log"></div>
    </div>
  </div>

 <script>
  let callActive = false; // Track if call is happening

  async function startCall() {
    const res = await fetch('/start-call');
    const data = await res.json();
    alert(data.status || data.error);

    // When a call starts, enable chat refresh
    if (data.status && data.status.includes("success")) {
      callActive = true;
      refreshChat(); // immediate update
    }
  }

  async function refreshChat() {
    if (!callActive) return; // ğŸš« don't poll if no call

    try {
      const res = await fetch('/conversation');
      const data = await res.json();
      const log = document.getElementById('chat-log');
      log.innerHTML = data.chat.map(c =>
        `<div class="msg ${c.role}"><strong>${c.role}:</strong> ${c.text}</div>`
      ).join('');

      // detect if call is active or ended
      const lastSystemMsg = [...data.chat].reverse().find(c => c.role === "system");
      if (lastSystemMsg && lastSystemMsg.text.includes("ğŸ“ Call status:")) {
        const status = lastSystemMsg.text.split(":").pop().trim();
        if (["completed", "failed", "busy", "no-answer"].includes(status)) {
          callActive = false;
          console.log("Call ended â€” stop polling.");
        } else {
          callActive = true; // in-progress or ringing
        }
      }

      // update phone and card in UI
      const phoneMatch = data.chat.find(c => c.text.includes('+91'));
      if (phoneMatch)
        document.getElementById('cust-phone').innerText =
          phoneMatch.text.match(/\+91\d{10}/)?.[0] || '+91XXXXXXXXXX';
      if (data.chat.some(c => c.text.toLowerCase().includes('blocked')))
        document.getElementById('card').innerText = 'Blocked';
    } catch (err) {
      console.warn('Chat refresh failed', err);
    }
  }

  // Poll every 2 s only when active
  setInterval(() => {
    if (callActive) refreshChat();
  }, 2000);
</script>

</body>
</html>
